{% extends "admin_base.html" %}
{% block admin_content %}

<h1 class="page-heading flex-heading">
  <img src="{{ url_for('static', filename='icons/vote.svg') }}" alt="Manage Candidates" class="heading-icon-lg" />
  Manage Candidates
</h1>

<!-- Add Candidate -->
<div class="cta-row">
  <div class="cta">
    <form method="POST" action="{{ url_for('manage_candidates') }}" class="inline-form">
      <input type="hidden" name="action" value="add">
      <input type="hidden" id="reg-no" name="reg_no">

      <input list="student-list" id="student-selector" name="name" placeholder="Start typing name..." required class="input-text" />
      <datalist id="student-list">
        {% for s in students %}
          <option value="{{ s.name }}" data-reg="{{ s.reg_no }}" data-avatar="{{ s.avatar }}">
        {% endfor %}
      </datalist>

      <select id="position-id" name="position_id" required class="input-select">
        <option value="" disabled selected>Select Position</option>
        {% for pos in positions %}
          <option value="{{ pos.id }}">{{ pos.name }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="glass-btn btn-add">
        <img src="{{ url_for('static', filename='icons/plus.svg') }}" alt="Add" class="btn-icon" />
        Add Candidate
      </button>
    </form>
  </div>

  <!-- Avatar Preview -->
  <div class="info-box" style="display: flex; align-items: center; gap: 1rem;">
    <img id="selected-avatar" src="" alt="Selected Avatar" class="avatar-preview" />
    <div>
      <p><strong>Selected Student:</strong> <span id="selected-name">None</span></p>
    </div>
  </div>
</div>

<!-- Candidate List -->
<h3 class="section-subheading">Candidate List</h3>
<div class="custom-search-holder"></div>

<table class="glass-table candidate-table" role="grid" aria-label="Candidate List">
  <thead>
    <tr>
      <th>Name</th>
      <th>Reg No</th>
      <th>Position</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for c in candidates %}
    <tr>
      <td data-label="Name">{{ c.name }}</td>
      <td data-label="Reg No">{{ c.reg_no }}</td>
      <td data-label="Position">{{ c.position }}</td>
      <td data-label="Actions">
        <div class="inline-form">
          <!-- Edit -->
          <form method="POST" action="{{ url_for('manage_candidates') }}">
            <input type="hidden" name="action" value="edit">
            <input type="hidden" name="id" value="{{ c.id }}">
            <input type="text" name="name" value="{{ c.name }}" required class="input-text" />
            <select name="position_id" required class="input-select">
              {% for pos in positions %}
                <option value="{{ pos.id }}" {% if pos.name == c.position %}selected{% endif %}>{{ pos.name }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="glass-btn btn-edit">
              <img src="{{ url_for('static', filename='icons/edit.svg') }}" alt="Update" class="btn-icon" />
              Update
            </button>
          </form>

          <!-- Delete -->
          <form method="POST" action="{{ url_for('manage_candidates') }}" onsubmit="return confirm('Delete this candidate?');">
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="id" value="{{ c.id }}">
            <button type="submit" class="glass-btn btn-delete">
              <img src="{{ url_for('static', filename='icons/trash.svg') }}" alt="Delete" class="btn-icon" />
              Delete
            </button>
          </form>
        </div>
      </td>
    </tr>
    {% endfor %}
    {% if candidates|length == 0 %}
    <tr>
      <td colspan="4" style="text-align: center;">No candidates found.</td>
    </tr>
    {% endif %}
  </tbody>
</table>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
  $(document).ready(function () {
    const table = $('.candidate-table').DataTable({
      dom: '<"search-container"f>rt<"bottom"ip>',
      columnDefs: [{ orderable: false, targets: -1 }],
      paging: true,
      responsive: true
    });

    setTimeout(function () {
      $('.search-container').appendTo('.custom-search-holder');
      $('.dataTables_filter label').contents().filter(function () {
        return this.nodeType === 3;
      }).remove();
    }, 0);
  });

  document.getElementById('student-selector').addEventListener('input', function () {
    const input = this.value;
    const options = document.querySelectorAll('#student-list option');
    let found = false;

    for (const option of options) {
      if (option.value === input) {
        const reg = option.getAttribute('data-reg');
        const avatar = option.getAttribute('data-avatar');
        document.getElementById('reg-no').value = reg;
        document.getElementById('selected-name').textContent = input;
        const avatarElem = document.getElementById('selected-avatar');
        avatarElem.src = `/static/${avatar}`;
        avatarElem.style.display = 'block';
        found = true;
        break;
      }
    }

    if (!found) {
      document.getElementById('reg-no').value = "";
      document.getElementById('selected-name').textContent = "None";
      const avatarElem = document.getElementById('selected-avatar');
      avatarElem.src = "";
      avatarElem.style.display = 'none';
    }
  });
</script>

<style>
:root {
  --button-bg: #007aff;
  --text: #1e1e1e;
  --glass-bg: rgba(255, 255, 255, 0.1);
}
@media (prefers-color-scheme: dark) {
  :root {
    --button-bg: #3a65b5;
    --text: #ddd;
    --glass-bg: rgba(0, 0, 0, 0.3);
  }
}

.input-text,
.input-select {
  height: 42px;
  padding: 0 14px;
  font-size: 0.95rem;
  border-radius: 12px;
  border: none;
  background: var(--glass-bg);
  color: var(--text);
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
  vertical-align: middle;
}
@media (prefers-color-scheme: dark) {
  .input-text, .input-select {
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.15);
  }
}

.inline-form {
  display: inline-flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin: 0.25rem 0;
}

.glass-btn {
  padding: 10px 18px;
  border: none;
  border-radius: 12px;
  color: white;
  font-weight: 700;
  cursor: pointer;
  backdrop-filter: blur(6px);
  transition: all 0.25s ease;
  font-size: 0.95rem;
  margin: 3px 4px;
  user-select: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--button-bg);
  flex-shrink: 0;
  height: 42px;
  box-sizing: border-box;
}
.glass-btn:hover {
  transform: scale(1.05);
  filter: brightness(1.1);
}
.btn-delete {
  background: rgba(220, 53, 69, 0.85);
}
.btn-delete:hover {
  background: rgba(220, 53, 69, 1);
}
.btn-icon {
  width: 16px;
  height: 16px;
}
@media (prefers-color-scheme: dark) {
  .btn-icon {
    filter: invert(1) drop-shadow(0 0 2px white);
  }
}
.section-subheading {
  margin-top: 2rem;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text);
}
.avatar-preview {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: none;
}

/* Search box styling */
.custom-search-holder {
  display: flex;
  justify-content: flex-start;
  margin: 1rem 0 1.5rem 0;
}
.dataTables_filter {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.dataTables_filter input {
  border-radius: 12px;
  border: none;
  padding: 10px 14px 10px 38px;
  font-size: 1rem;
  backdrop-filter: blur(8px);
  background: var(--glass-bg);
  color: var(--text);
  min-width: 250px;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
  background-image: url("{{ url_for('static', filename='icons/search.svg') }}");
  background-repeat: no-repeat;
  background-position: 12px center;
  background-size: 16px;
}
@media (prefers-color-scheme: dark) {
  .dataTables_filter input {
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
    background-image: url("{{ url_for('static', filename='icons/search.svg') }}");
    filter: invert(1);
  }
}
</style>

{% endblock %}
