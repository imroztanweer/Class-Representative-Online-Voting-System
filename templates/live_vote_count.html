{% extends "student_base.html" %}
{% block student_content %}

<h1 class="page-heading flex-heading">
  <img src="{{ url_for('static', filename='icons/bar.svg') }}" alt="Live Vote Count" class="heading-icon-lg svg-glow" />
  Live Vote Count
</h1>

{% if results %}
  {% set ns = namespace(grouped={}) %}
  {% for item in results|dictsort %}
    {% set pos = item[0] %}
    {% if pos not in ns.grouped %}
      {% set _ = ns.grouped.update({ pos: item[1] }) %}
    {% endif %}
  {% endfor %}

  <div class="charts-wrapper">
    {% for pos, candidates in ns.grouped.items() %}
      <div class="chart-block glass-table">
        <h3 class="section-subheading">{{ pos }}</h3>
        <div class="chart-container">
          <canvas id="chart-{{ loop.index }}"></canvas>
        </div>
      </div>
    {% endfor %}
  </div>

  <script src="{{ url_for('static', filename='chart.min.js') }}"></script>
  <script>
    {% for pos, candidates in ns.grouped.items() %}
      const ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
      new Chart(ctx{{ loop.index }}, {
        type: 'bar',
        data: {
          labels: [{% for c in candidates %}"{{ c.candidate }}"{% if not loop.last %}, {% endif %}{% endfor %}],
          datasets: [{
            label: 'Votes',
            data: [{% for c in candidates %}{{ c.votes }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
              'rgba(59,130,246,0.6)', 'rgba(34,197,94,0.6)',
              'rgba(234,179,8,0.6)', 'rgba(239,68,68,0.6)',
              'rgba(168,85,247,0.6)', 'rgba(14,165,233,0.6)'
            ],
            borderColor: 'rgba(0,0,0,0.1)',
            borderWidth: 1,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    {% endfor %}
  </script>
{% else %}
  <p>No vote data available yet.</p>
{% endif %}

<style>
.page-heading {
  font-size: 2.4rem;
  font-weight: 800;
  margin-bottom: 1rem;
  background: linear-gradient(to right, #007aff, #5856d6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.flex-heading {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

.section-subheading {
  margin-top: 2rem;
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--text);
}

.heading-icon-lg {
  width: 2.2rem;
  height: 2.2rem;
}
.svg-glow {
  filter: drop-shadow(0 0 5px rgba(59,130,246,0.8));
}

.charts-wrapper {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.chart-block {
  padding: 1.5rem;
  background: var(--glass-bg);
  border-radius: 0.75rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.chart-container {
  position: relative;
  width: 100%;
  max-width: 500px;
  height: 200px;
  margin: 0 auto;
}

@media (max-width: 600px) {
  .chart-container {
    max-width: 100%;
    height: 180px;
  }
}
</style>

{% endblock %}
