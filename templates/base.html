<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#007aff" />
  <title>{{ title if title else "VoteX - Elections Made Effortless" }}</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    #starfield {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
    }

    .hamburger div {
      background: #000;
      transition: background 0.3s;
    }

    html[data-theme="dark"] .hamburger div {
      background: #fff;
    }

    .theme-toggle-icon {
      background: transparent !important;
      border: none;
      padding: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .theme-toggle-icon img {
      width: 24px;
      height: 24px;
    }

    html[data-theme="dark"] .theme-toggle-icon img {
      filter: invert(1);
    }

    .spin-once {
      animation: spin 0.6s ease-in-out;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .mobile-menu .mobile-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
  </style>
</head>

<body>
  <canvas id="starfield"></canvas>
  <div class="floating-shape shape1"></div>
  <div class="floating-shape shape2"></div>
  <div class="floating-shape shape3"></div>
  <div id="drawer-overlay" class="drawer-overlay"></div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container" style="display: flex; align-items: center; width: 100%;">
      <!-- Logo -->
      <div class="logo-box" onclick="handleLogoClick()" style="cursor: pointer; display: flex; align-items: center;">
        <img id="nav-logo" src="{{ url_for('static', filename='lightLogo.png') }}" alt="VoteX Logo" class="logo" />
        <span class="nav-title">Elections made Effortless</span>
      </div>

      <!-- Hamburger -->
      <div class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle mobile menu">
        <div></div><div></div><div></div>
      </div>

      <!-- Actions -->
      <div class="nav-actions" id="nav-actions" style="margin-left: auto; display: flex; align-items: center; gap: 1rem;">
        <div id="header-clock" class="nav-clock"></div>
        {% if session.get('user') %}
          <a href="{{ url_for('logout') }}" class="nav-btn">Logout</a>
        {% else %}
          {% if request.path != url_for('login') %}
            <a href="{{ url_for('login') }}" class="nav-btn">Login</a>
          {% endif %}
        {% endif %}
        <button class="theme-toggle-icon" id="theme-toggle-btn" title="Toggle Theme">
          <img id="theme-icon" src="{{ url_for('static', filename='icons/moon.svg') }}" alt="Toggle Theme" />
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobile-menu">
      <div class="mobile-actions">
        {% if session.get('user') %}
          <a href="{{ url_for('logout') }}" class="nav-btn">Logout</a>
        {% else %}
          {% if request.path != url_for('login') %}
            <a href="{{ url_for('login') }}" class="nav-btn">Login</a>
          {% endif %}
        {% endif %}
        <button class="theme-toggle-icon" id="theme-toggle-btn-mobile" title="Toggle Theme">
          <img id="theme-icon-mobile" src="{{ url_for('static', filename='icons/moon.svg') }}" alt="Toggle Theme" />
        </button>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main>{% block content %}{% endblock %}</main>

  <!-- Footer -->
  <footer>
    <div class="footer-container">
      <div class="footer-credit">Designed by Imroz Tanweer</div>
      <div>
        <a href="https://github.com/imroztanweer" target="_blank"><img src="{{ url_for('static', filename='icons/github.svg') }}" class="social-icon" /></a>
        <a href="https://www.linkedin.com/in/imroztanweer" target="_blank"><img src="{{ url_for('static', filename='icons/linkedin.svg') }}" class="social-icon" /></a>
        <a href="https://www.instagram.com/imroz.tanweer" target="_blank"><img src="{{ url_for('static', filename='icons/instagram.svg') }}" class="social-icon" /></a>
        <a href="mailto:imroztaneer@gmail.com"><img src="{{ url_for('static', filename='icons/email.svg') }}" class="social-icon" /></a>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    function handleLogoClick() {
      const isLoggedIn = {{ 'true' if session.get('user') else 'false' }};
      const isAdmin = {{ 'true' if session.get('role') == 'admin' else 'false' }};
      window.location.href = isLoggedIn
        ? (isAdmin ? "{{ url_for('admin_dashboard') }}" : "{{ url_for('student_dashboard') }}")
        : "{{ url_for('home') }}";
    }

    const htmlEl = document.documentElement;
    const logoEl = document.getElementById('nav-logo');
    const themeIcon = document.getElementById('theme-icon');
    const themeIconMobile = document.getElementById('theme-icon-mobile');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const themeToggleBtnMobile = document.getElementById('theme-toggle-btn-mobile');

    function setTheme(theme) {
      htmlEl.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);

      logoEl.src = theme === 'dark'
        ? "{{ url_for('static', filename='logo-dark-nobg.png') }}"
        : "{{ url_for('static', filename='logo-light-nobg.png') }}";

      const iconSrc = theme === 'dark'
        ? "{{ url_for('static', filename='icons/sun.svg') }}"
        : "{{ url_for('static', filename='icons/moon.svg') }}";
      themeIcon.src = iconSrc;
      themeIconMobile.src = iconSrc;
    }

    [themeToggleBtn, themeToggleBtnMobile].forEach(btn => {
      btn.addEventListener('click', () => {
        const currentTheme = htmlEl.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
        btn.classList.add('spin-once');
        setTimeout(() => btn.classList.remove('spin-once'), 600);
      });
    });

    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
    setTheme(initialTheme);

    function updateClock() {
      const now = new Date();
      const options = {
        weekday: 'short', year: 'numeric', month: 'short',
        day: 'numeric', hour: '2-digit', minute: '2-digit'
      };
      const str = now.toLocaleString('en-US', options);
      document.getElementById('header-clock').innerText = str;
    }

    setInterval(updateClock, 1000);
    updateClock();

    function toggleMobileMenu(forceClose = false) {
      const menu = document.getElementById('mobile-menu');
      const overlay = document.getElementById('drawer-overlay');
      if (forceClose) {
        menu.classList.remove('mobile-visible');
        overlay.classList.remove('visible');
      } else {
        menu.classList.toggle('mobile-visible');
        overlay.classList.toggle('visible');
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('#mobile-menu a, #theme-toggle-btn-mobile').forEach(el => {
        el.addEventListener('click', () => toggleMobileMenu(true));
      });
    });

    document.getElementById('drawer-overlay').addEventListener('click', () => toggleMobileMenu(true));

    // Starfield with parallax
    const canvas = document.getElementById("starfield");
    const ctx = canvas.getContext("2d");
    let stars = [];
    let scrollOffset = 0;

    window.addEventListener('scroll', () => {
      scrollOffset = window.scrollY * 0.2;
    });

    function initStars(count) {
      stars = [];
      for (let i = 0; i < count; i++) {
        stars.push({
          x: Math.random() * window.innerWidth,
          y: Math.random() * window.innerHeight,
          r: Math.random() * 1.5 + 0.5,
          speed: Math.random() * 0.5 + 0.2,
        });
      }
    }

    function animateStars() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = htmlEl.getAttribute("data-theme") === "dark" ? "white" : "black";
      stars.forEach(star => {
        star.y += star.speed;
        if (star.y > canvas.height) star.y = 0;

        const parallaxY = star.y + scrollOffset;
        ctx.beginPath();
        ctx.arc(star.x, parallaxY % canvas.height, star.r, 0, 2 * Math.PI);
        ctx.fill();
      });
      requestAnimationFrame(animateStars);
    }

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      initStars(160);
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    animateStars();

    // Floating shapes interaction
    document.addEventListener("mousemove", (e) => {
      const x = (e.clientX / window.innerWidth - 0.5) * 30;
      const y = (e.clientY / window.innerHeight - 0.5) * 30;
      document.querySelectorAll(".floating-shape").forEach(shape => {
        shape.style.transform = `translate(${x}px, ${y}px)`;
      });
    });
  </script>
</body>
</html>
