{% extends "admin_base.html" %}
{% block admin_content %}

<h1 class="page-heading flex-heading">
  <img src="{{ url_for('static', filename='icons/bar.svg') }}" alt="Vote Count" class="heading-icon-lg svg-glow" />
  Live Vote Count
</h1>

{% if vote_data %}
  {% set ns = namespace(grouped={}) %}
  {% for item in vote_data %}
    {% set pos = item.position %}
    {% if pos not in ns.grouped %}
      {% set _ = ns.grouped.update({ pos: [] }) %}
    {% endif %}
    {% set _ = ns.grouped[pos].append(item) %}
  {% endfor %}

  <div class="charts-wrapper">
    {% for pos, items in ns.grouped.items() %}
      <div class="chart-block glass-table">
        <h3 class="section-subheading">{{ pos }}</h3>
        <div class="chart-container">
          <canvas id="chart-{{ loop.index }}"></canvas>
        </div>
      </div>
    {% endfor %}
  </div>

  <script src="{{ url_for('static', filename='chart.min.js') }}"></script>
  <script>
    {% for pos, items in ns.grouped.items() %}
      const ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
      new Chart(ctx{{ loop.index }}, {
        type: 'bar',
        data: {
          labels: [{% for item in items %}"{{ item.candidate }}"{% if not loop.last %}, {% endif %}{% endfor %}],
          datasets: [{
            label: 'Votes',
            data: [{% for item in items %}{{ item.votes }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
              'rgba(59,130,246,0.6)', 'rgba(34,197,94,0.6)',
              'rgba(234,179,8,0.6)', 'rgba(239,68,68,0.6)',
              'rgba(168,85,247,0.6)', 'rgba(14,165,233,0.6)'
            ],
            borderColor: 'rgba(0,0,0,0.1)',
            borderWidth: 1,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    {% endfor %}
  </script>
{% else %}
  <p>No vote data available yet.</p>
{% endif %}

<hr class="section-divider">

<h3 class="section-subheading flex-heading">
  <img src="{{ url_for('static', filename='icons/inbox.svg') }}" alt="Ballots" class="heading-icon-lg svg-glow" />
  All Ballots
</h3>

<div class="glass-table-wrapper">
  <table class="glass-table">
    <thead>
      <tr>
        <th>Vote ID</th>
        <th>Student Reg No</th>
        <th>Candidate</th>
        <th>Position</th>
        <th>Timestamp</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for vote in ballots %}
      <tr>
        <td data-label="Vote ID">{{ vote.id }}</td>
        <td data-label="Student Reg No">{{ vote.student_regno }}</td>
        <td data-label="Candidate">{{ vote.candidate }}</td>
        <td data-label="Position">{{ vote.position }}</td>
        <td data-label="Timestamp">{{ vote.timestamp }}</td>
        <td data-label="Action">
          <form action="{{ url_for('admin_delete_vote', vote_id=vote.id) }}" method="POST" onsubmit="return confirmDelete(this);" class="inline-form">
            <input type="text" name="remark" placeholder="Reason" required class="remark-input">
            <button type="submit" class="glass-btn btn-delete">
              <img src="{{ url_for('static', filename='icons/trash.svg') }}" alt="Delete" class="btn-icon" />
              Delete
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  function confirmDelete(form) {
    const reason = form.querySelector('input[name="remark"]').value.trim();
    if (!reason) {
      alert("Please enter a remark before deleting.");
      return false;
    }
    return confirm("Are you sure you want to delete this vote?");
  }
</script>

<style>
.page-heading {
  font-size: 2.4rem;
  font-weight: 800;
  margin-bottom: 1rem;
  background: linear-gradient(to right, #007aff, #5856d6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.flex-heading {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

.section-subheading {
  margin-top: 2rem;
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--text);
}

.heading-icon-lg {
  width: 2.2rem;
  height: 2.2rem;
}
.svg-glow {
  filter: drop-shadow(0 0 5px rgba(59,130,246,0.8));
}

.section-divider {
  margin: 2.5rem 0;
  border: none;
  border-top: 1px solid rgba(128, 128, 128, 0.2);
}

.charts-wrapper {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.chart-block {
  padding: 1.5rem;
  background: var(--glass-bg);
  border-radius: 0.75rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.chart-container {
  position: relative;
  width: 100%;
  max-width: 500px;
  height: 200px;
  margin: 0 auto;
}


.glass-table-wrapper {
  overflow-x: auto;
}

.glass-table {
  width: 100%;
  border-collapse: collapse;
  border-spacing: 0;
  border-radius: 16px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(16px);
  box-shadow: 0 14px 32px rgba(0, 0, 0, 0.08);
  margin-top: 1.5rem;
}

.glass-table thead {
  background-color: var(--button-bg);
}

.glass-table thead th,
.glass-table td {
  padding: 14px;
  font-size: 1rem;
  color: var(--text);
  text-align: center;
}

.glass-table td {
  background: rgba(255, 255, 255, 0.04);
  border-bottom: 1px solid rgba(255, 255, 255, 0.07);
}

.glass-table tr:hover {
  background: rgba(0, 122, 255, 0.06);
}

@media screen and (max-width: 768px) {
  .glass-table thead {
    display: none;
  }
  .glass-table, .glass-table tbody, .glass-table tr, .glass-table td {
    display: block;
    width: 100%;
    text-align: left;
  }
  .glass-table tr {
    margin-bottom: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .glass-table td::before {
    content: attr(data-label);
    font-weight: 600;
    display: block;
    margin-bottom: 4px;
    color: var(--text);
    opacity: 0.75;
  }
  .glass-table td[data-label="Action"] {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
}

/* Buttons */
.glass-btn {
  padding: 10px 18px;
  border: none;
  border-radius: 12px;
  color: white;
  font-weight: 700;
  cursor: pointer;
  backdrop-filter: blur(6px);
  transition: all 0.25s ease;
  font-size: 0.95rem;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--button-bg);
}
.glass-btn:hover {
  transform: scale(1.05);
  filter: brightness(1.1);
}
.btn-icon {
  width: 16px;
  height: 16px;
}
.btn-delete {
  background: rgba(220, 53, 69, 0.85);
}
.btn-delete:hover {
  background: rgba(220, 53, 69, 1);
}

/* Delete form layout */
.inline-form {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.inline-form .remark-input {
  padding: 0.4rem 0.6rem;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 0.9rem;
  width: 100%;
}
@media (min-width: 600px) {
  .inline-form {
    flex-direction: row;
    align-items: center;
    gap: 0.6rem;
  }
  .inline-form .remark-input {
    flex: 1;
  }
  .inline-form .glass-btn {
    margin-top: 0 !important;
    white-space: nowrap;
  }
}
</style>

{% endblock %}
