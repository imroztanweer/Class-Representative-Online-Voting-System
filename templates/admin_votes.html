{% extends "admin_base.html" %}
{% block admin_content %}

<div class="container fade-in">
  <h2 style="margin-bottom: 2rem;">üìä Live Vote Count</h2>

  {% if vote_data %}
    {% set ns = namespace(grouped={}) %}
    {% for item in vote_data %}
      {% set pos = item.position %}
      {% if pos not in ns.grouped %}
        {% set _ = ns.grouped.update({ pos: [] }) %}
      {% endif %}
      {% set _ = ns.grouped[pos].append(item) %}
    {% endfor %}

    <div class="charts-wrapper" style="display: flex; flex-direction: column; gap: 2rem;">
      {% for pos, items in ns.grouped.items() %}
        <div class="chart-block glass-table" style="padding: 1.5rem;">
          <h3 style="margin-bottom: 1rem;">üìå {{ pos }}</h3>
          <div class="chart-container" style="position: relative; height: 320px; width: 100%;">
            <canvas id="chart-{{ loop.index }}" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>
      {% endfor %}
    </div>

    <script src="{{ url_for('static', filename='chart.min.js') }}"></script>
    <script>
      {% for pos, items in ns.grouped.items() %}
        const ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
        new Chart(ctx{{ loop.index }}, {
          type: 'bar',
          data: {
            labels: [{% for item in items %}"{{ item.candidate }}",{% endfor %}],
            datasets: [{
              label: 'Votes',
              data: [{% for item in items %}{{ item.votes }},{% endfor %}],
              backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(153, 102, 255, 0.5)',
                'rgba(255, 159, 64, 0.5)'
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
              ],
              borderWidth: 1,
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0 }
              }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      {% endfor %}
    </script>
  {% else %}
    <p style="margin-bottom: 2rem;">No vote data available yet.</p>
  {% endif %}

  <hr style="margin: 2.5rem 0;">

  <h3 style="margin-bottom: 1rem;">üó≥Ô∏è All Ballots</h3>

  <div class="glass-table-wrapper" style="overflow-x: auto;">
    <table class="glass-table">
      <thead>
        <tr>
          <th>Vote ID</th>
          <th>Student Reg No</th>
          <th>Candidate</th>
          <th>Position</th>
          <th>Timestamp</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for vote in ballots %}
        <tr>
          <td>{{ vote.id }}</td>
          <td>{{ vote.student_regno }}</td>
          <td>{{ vote.candidate }}</td>
          <td>{{ vote.position }}</td>
          <td>{{ vote.timestamp }}</td>
          <td>
            <form action="{{ url_for('admin_delete_vote', vote_id=vote.id) }}" method="POST" onsubmit="return confirmDelete(this);">
              <input type="text" name="remark" placeholder="Reason" required class="remark-input" style="margin-bottom: 6px;">
              <button type="submit" class="btn-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  function confirmDelete(form) {
    const reason = form.querySelector('input[name="remark"]').value.trim();
    if (!reason) {
      alert("Please enter a remark before deleting.");
      return false;
    }
    return confirm("Are you sure you want to delete this vote?");
  }
</script>

{% endblock %}
